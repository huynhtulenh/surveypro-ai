<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SurveyPro AI</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="/dashboard" class="navbar-brand">SurveyPro AI</a>
            <ul class="navbar-nav" id="adminNav">
                <li><a href="/dashboard" class="nav-link">üìã Kh·∫£o s√°t</a></li>
                <li><a href="/admin/dashboard" class="nav-link">üè¢ Qu·∫£n l√Ω</a></li>
                <!-- Dynamic items will be added here -->
            </ul>
        </div>
    </nav>

    <div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <!-- Header -->
        <div class="mb-4">
            <h1>Admin Dashboard</h1>
            <p class="text-secondary" id="companyName"></p>
        </div>

        <!-- Statistics Cards -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card" style="background: var(--gradient-primary); color: white;">
                <div class="card-body" style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 700;" id="totalAdmins">0</div>
                    <div style="font-size: 1.125rem;">T·ªïng Admins</div>
                </div>
            </div>

            <div class="card" style="background: var(--gradient-accent); color: white;">
                <div class="card-body" style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 700;" id="totalUsers">0</div>
                    <div style="font-size: 1.125rem;">T·ªïng Users</div>
                </div>
            </div>

            <div class="card" style="background: var(--gradient-success); color: white;">
                <div class="card-body" style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 700;" id="totalSurveys">0</div>
                    <div style="font-size: 1.125rem;">T·ªïng Kh·∫£o s√°t</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="card-header">
                <div
                    style="display: flex; gap: 1rem; border-bottom: 2px solid var(--border-color); margin: -1rem -1rem 1rem -1rem; padding: 0 1rem;">
                    <button class="tab-btn active" onclick="switchTab('companies')" id="companiesTab">
                        üè¢ C√¥ng ty
                    </button>
                    <button class="tab-btn" onclick="switchTab('admins')" id="adminsTab">
                        üë§ Admins
                    </button>
                </div>
            </div>

            <!-- Companies Tab -->
            <div id="companiesContent" class="tab-content active">
                <div class="card-body">
                    <div class="flex-between mb-3">
                        <h3>Danh s√°ch c√¥ng ty</h3>
                        <button onclick="showCreateCompanyModal()" class="btn btn-primary">+ T·∫°o c√¥ng ty</button>
                    </div>

                    <div id="companiesContainer">
                        <div class="flex-center" style="padding: 3rem 0;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admins Tab -->
            <div id="adminsContent" class="tab-content" style="display: none;">
                <div class="card-body">
                    <div class="flex-between mb-3">
                        <h3>Danh s√°ch admins</h3>
                        <button onclick="showCreateAdminModal()" class="btn btn-primary">+ Th√™m admin</button>
                    </div>

                    <div id="adminsContainer">
                        <div class="flex-center" style="padding: 3rem 0;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Company Modal -->
    <div id="createCompanyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>T·∫°o c√¥ng ty m·ªõi</h3>
                <button class="modal-close" onclick="closeCreateCompanyModal()">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">T√™n c√¥ng ty *</label>
                    <input type="text" id="newCompanyName" class="form-control" placeholder="VD: Acme Corporation">
                </div>
                <div class="flex gap-sm mt-3">
                    <button onclick="createCompany()" class="btn btn-primary">T·∫°o</button>
                    <button onclick="closeCreateCompanyModal()" class="btn btn-secondary">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Admin Modal -->
    <div id="createAdminModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Th√™m admin m·ªõi</h3>
                <button class="modal-close" onclick="closeCreateAdminModal()">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="newAdminEmail" class="form-control" placeholder="admin@company.com">
                </div>
                <div class="form-group">
                    <label class="form-label">M·∫≠t kh·∫©u *</label>
                    <input type="password" id="newAdminPassword" class="form-control" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
                </div>
                <div class="form-group">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="newAdminPhone" class="form-control" placeholder="+84123456789">
                </div>
                <div class="flex gap-sm mt-3">
                    <button onclick="createAdmin()" class="btn btn-primary">Th√™m</button>
                    <button onclick="closeCreateAdminModal()" class="btn btn-secondary">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentCompanyId = null;
        let adminInfo = null;

        // Check authentication
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            window.location.href = '/admin/login';
        }

        // Load admin info
        try {
            adminInfo = JSON.parse(localStorage.getItem('adminInfo'));
            // Extract company ID - handle both object and string formats
            if (adminInfo && adminInfo.company) {
                if (typeof adminInfo.company === 'object') {
                    currentCompanyId = adminInfo.company.id || adminInfo.company._id;
                } else {
                    currentCompanyId = adminInfo.company;
                }
            }
            console.log('Current Company ID:', currentCompanyId); // Debug log
            console.log('Admin Info:', adminInfo); // Debug log
            // Update navbar with admin email
            updateAdminNavbar();
        } catch (error) {
            console.error('Error loading admin info:', error);
        }

        function updateAdminNavbar() {
            const navbarNav = document.getElementById('adminNav');
            if (navbarNav && adminInfo) {
                // Remove any existing dynamic items (email and logout)
                const existingItems = navbarNav.querySelectorAll('li:not(:first-child):not(:nth-child(2))');
                existingItems.forEach(item => item.remove());

                const emailLi = document.createElement('li');
                emailLi.innerHTML = `<span class="nav-link">${adminInfo.email}</span>`;
                navbarNav.appendChild(emailLi);

                const logoutLi = document.createElement('li');
                logoutLi.innerHTML = `<a href="#" onclick="adminLogout(); return false;" class="nav-link">ƒêƒÉng xu·∫•t</a>`;
                navbarNav.appendChild(logoutLi);
            }
        }

        function adminLogout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminInfo');
            window.location.href = '/admin/login';
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            document.getElementById(`${tab}Tab`).classList.add('active');
            document.getElementById(`${tab}Content`).style.display = 'block';

            if (tab === 'companies') {
                loadCompanies();
            } else if (tab === 'admins') {
                loadAdmins();
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                console.log('Loading stats for company:', currentCompanyId); // Debug log
                const response = await fetch(`${API_BASE_URL}/companies/${currentCompanyId}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                console.log('Stats response:', data); // Debug log

                if (response.ok) {
                    document.getElementById('companyName').textContent = `C√¥ng ty: ${data.company.name}`;
                    document.getElementById('totalAdmins').textContent = data.stats.admins || 0;
                    document.getElementById('totalUsers').textContent = data.stats.users || 0;
                    document.getElementById('totalSurveys').textContent = data.stats.surveys || 0;
                } else {
                    console.error('Failed to load stats:', data);
                    // Set default values if API fails
                    document.getElementById('companyName').textContent = adminInfo?.company?.name ? `C√¥ng ty: ${adminInfo.company.name}` : '';
                    document.getElementById('totalAdmins').textContent = '0';
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalSurveys').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Set default values on error
                document.getElementById('companyName').textContent = adminInfo?.company?.name ? `C√¥ng ty: ${adminInfo.company.name}` : '';
                document.getElementById('totalAdmins').textContent = '0';
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('totalSurveys').textContent = '0';
            }
        }

        // Load companies
        async function loadCompanies() {
            try {
                const response = await fetch(`${API_BASE_URL}/companies`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                const container = document.getElementById('companiesContainer');

                if (data.companies.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center">Ch∆∞a c√≥ c√¥ng ty n√†o</p>';
                    return;
                }

                container.innerHTML = data.companies.map(company => `
          <div class="card mb-2">
            <div class="card-body">
              <div class="flex-between">
                <div>
                  <h4 style="margin: 0;">${company.name}</h4>
                  <small class="text-muted">T·∫°o: ${ui.formatDate(company.createdAt)}</small>
                </div>
                <div class="flex gap-sm">
                  <button onclick="viewCompanyStats('${company._id}')" class="btn btn-sm btn-secondary">üìä Th·ªëng k√™</button>
                  <button onclick="deleteCompany('${company._id}')" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        // Load admins
        async function loadAdmins() {
            try {
                const response = await fetch(`${API_BASE_URL}/admins/company/${currentCompanyId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                const container = document.getElementById('adminsContainer');

                if (data.admins.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center">Ch∆∞a c√≥ admin n√†o</p>';
                    return;
                }

                container.innerHTML = data.admins.map(admin => `
          <div class="card mb-2">
            <div class="card-body">
              <div class="flex-between">
                <div>
                  <h4 style="margin: 0;">${admin.email}</h4>
                  <small class="text-muted">
                    ${admin.phone || 'Ch∆∞a c√≥ SƒêT'} ‚Ä¢ T·∫°o: ${ui.formatDate(admin.createdAt)}
                  </small>
                </div>
                <div class="flex gap-sm">
                  <button onclick="deleteAdmin('${admin._id}')" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
            } catch (error) {
                console.error('Error loading admins:', error);
            }
        }

        // Company modals
        function showCreateCompanyModal() {
            document.getElementById('createCompanyModal').classList.add('active');
        }

        function closeCreateCompanyModal() {
            document.getElementById('createCompanyModal').classList.remove('active');
            document.getElementById('newCompanyName').value = '';
        }

        async function createCompany() {
            const name = document.getElementById('newCompanyName').value.trim();

            if (!name) {
                ui.showAlert('Vui l√≤ng nh·∫≠p t√™n c√¥ng ty', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/companies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                ui.showAlert('T·∫°o c√¥ng ty th√†nh c√¥ng!', 'success');
                closeCreateCompanyModal();
                loadCompanies();
            } catch (error) {
                ui.showAlert(error.message, 'error');
            }
        }

        async function deleteCompany(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng ty n√†y?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/companies/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    ui.showAlert('X√≥a c√¥ng ty th√†nh c√¥ng!', 'success');
                    loadCompanies();
                }
            } catch (error) {
                ui.showAlert('L·ªói khi x√≥a c√¥ng ty', 'error');
            }
        }

        async function viewCompanyStats(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/companies/${id}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                alert(`Th·ªëng k√™ ${data.company.name}:\n\nAdmins: ${data.stats.admins}\nUsers: ${data.stats.users}\nSurveys: ${data.stats.surveys}`);
            } catch (error) {
                ui.showAlert('L·ªói khi t·∫£i th·ªëng k√™', 'error');
            }
        }

        // Admin modals
        function showCreateAdminModal() {
            document.getElementById('createAdminModal').classList.add('active');
        }

        function closeCreateAdminModal() {
            document.getElementById('createAdminModal').classList.remove('active');
            document.getElementById('newAdminEmail').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('newAdminPhone').value = '';
        }

        async function createAdmin() {
            const email = document.getElementById('newAdminEmail').value.trim();
            const password = document.getElementById('newAdminPassword').value;
            const phone = document.getElementById('newAdminPhone').value.trim();

            if (!email || !password) {
                ui.showAlert('Email v√† m·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admins/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        phone: phone || undefined,
                        companyId: currentCompanyId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                ui.showAlert('Th√™m admin th√†nh c√¥ng!', 'success');
                closeCreateAdminModal();
                loadAdmins();
                loadStats();
            } catch (error) {
                ui.showAlert(error.message, 'error');
            }
        }

        async function deleteAdmin(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a admin n√†y?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/admins/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    ui.showAlert('X√≥a admin th√†nh c√¥ng!', 'success');
                    loadAdmins();
                    loadStats();
                }
            } catch (error) {
                ui.showAlert('L·ªói khi x√≥a admin', 'error');
            }
        }

        // Load initial data
        loadStats();
        loadCompanies();
    </script>

    <style>
        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
    </style>
</body>

</html>