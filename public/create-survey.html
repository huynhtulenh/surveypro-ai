<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="T·∫°o kh·∫£o s√°t m·ªõi - SurveyPro AI">
    <title>T·∫°o kh·∫£o s√°t - SurveyPro AI</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .question-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-base);
        }

        .question-item:hover {
            border-color: var(--border-hover);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .option-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .option-item input {
            flex: 1;
        }
    </style>
</head>

<body>
    <!-- Admin page: Create/Edit surveys -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="/dashboard" class="navbar-brand">SurveyPro AI</a>
            <ul class="navbar-nav">
                <li><a href="/dashboard" class="nav-link">üìã Kh·∫£o s√°t</a></li>
                <li><a href="/admin/dashboard" class="nav-link">üè¢ Qu·∫£n l√Ω</a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="max-width: 900px; margin-top: 3rem; margin-bottom: 3rem;">
        <div class="flex-between mb-4">
            <div>
                <h1 id="pageTitle">T·∫°o kh·∫£o s√°t m·ªõi</h1>
                <p class="text-secondary">Thi·∫øt k·∫ø kh·∫£o s√°t c·ªßa b·∫°n</p>
            </div>
            <a href="/dashboard" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
        </div>

        <!-- Survey Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Th√¥ng tin kh·∫£o s√°t</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="surveyTitle" class="form-label">Ti√™u ƒë·ªÅ kh·∫£o s√°t *</label>
                    <input type="text" id="surveyTitle" class="form-control" placeholder="VD: Kh·∫£o s√°t v·ªÅ smartphone"
                        required>
                </div>

                <div class="form-group">
                    <label for="surveyDescription" class="form-label">M√¥ t·∫£</label>
                    <textarea id="surveyDescription" class="form-control"
                        placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ kh·∫£o s√°t c·ªßa b·∫°n" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="surveyStatus" class="form-label">Tr·∫°ng th√°i</label>
                    <select id="surveyStatus" class="form-control">
                        <option value="draft">Nh√°p</option>
                        <option value="active" selected>ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="closed">ƒê√£ ƒë√≥ng</option>
                    </select>
                    <small class="text-muted">‚ö†Ô∏è Ch·ªâ kh·∫£o s√°t "ƒêang ho·∫°t ƒë·ªông" m·ªõi c√≥ th·ªÉ truy c·∫≠p c√¥ng khai</small>
                </div>
            </div>
        </div>

        <!-- Questions -->
        <div class="card mb-3">
            <div class="card-header flex-between">
                <h3>C√¢u h·ªèi</h3>
                <button onclick="showAddQuestionModal()" class="btn btn-sm btn-primary">+ Th√™m c√¢u h·ªèi</button>
            </div>
            <div class="card-body">
                <div id="questionsContainer">
                    <p class="text-secondary text-center" style="padding: 2rem 0;">
                        Ch∆∞a c√≥ c√¢u h·ªèi n√†o. Nh·∫•n "Th√™m c√¢u h·ªèi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-md">
            <button onclick="saveSurvey()" class="btn btn-success btn-lg">üíæ L∆∞u kh·∫£o s√°t</button>
            <button onclick="previewSurvey()" class="btn btn-outline btn-lg">üëÅÔ∏è Xem tr∆∞·ªõc</button>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Th√™m c√¢u h·ªèi</h3>
                <button class="modal-close" onclick="closeAddQuestionModal()">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
                    <select id="questionType" class="form-control" onchange="updateQuestionForm()">
                        <option value="text">VƒÉn b·∫£n (Text)</option>
                        <option value="radio">M·ªôt l·ª±a ch·ªçn (Radio)</option>
                        <option value="checkbox">Nhi·ªÅu l·ª±a ch·ªçn (Checkbox)</option>
                        <option value="date">Ng√†y th√°ng (Date)</option>
                        <option value="table-single">B·∫£ng - M·ªôt l·ª±a ch·ªçn</option>
                        <option value="table-multiple">B·∫£ng - Nhi·ªÅu l·ª±a ch·ªçn</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">C√¢u h·ªèi *</label>
                    <input type="text" id="questionText" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n">
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" id="questionRequired" class="form-check-input">
                    <label for="questionRequired" class="form-check-label">B·∫Øt bu·ªôc tr·∫£ l·ªùi</label>
                </div>

                <!-- Options for radio/checkbox -->
                <div id="optionsSection" style="display: none;">
                    <label class="form-label">C√°c l·ª±a ch·ªçn</label>
                    <div id="optionsList"></div>
                    <button onclick="addOption()" class="btn btn-sm btn-secondary mt-2">+ Th√™m l·ª±a ch·ªçn</button>
                </div>

                <!-- Table config -->
                <div id="tableSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">H√†ng (m·ªói h√†ng m·ªôt d√≤ng)</label>
                        <textarea id="tableRows" class="form-control" rows="3"
                            placeholder="iPhone&#10;Samsung&#10;Oppo"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">C·ªôt (m·ªói c·ªôt m·ªôt d√≤ng)</label>
                        <textarea id="tableCols" class="form-control" rows="3"
                            placeholder="R·∫•t th√≠ch&#10;Th√≠ch&#10;B√¨nh th∆∞·ªùng&#10;Kh√¥ng th√≠ch"></textarea>
                    </div>
                </div>

                <div class="flex gap-sm mt-3">
                    <button onclick="addQuestion()" class="btn btn-primary">Th√™m c√¢u h·ªèi</button>
                    <button onclick="closeAddQuestionModal()" class="btn btn-secondary">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Protect page - require admin authentication
        requireAdminAuth();
        
        // Update navbar with admin info
        updateAdminNavbar();

        let questions = [];
        let editingQuestionIndex = -1;
        let surveyId = null;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('id')) {
            surveyId = urlParams.get('id');
            loadSurvey(surveyId);
        }

        async function loadSurvey(id) {
            try {
                const data = await adminApi.get(`/surveys/${id}`);
                const survey = data.survey;

                document.getElementById('pageTitle').textContent = 'Ch·ªânh s·ª≠a kh·∫£o s√°t';
                document.getElementById('surveyTitle').value = survey.title;
                document.getElementById('surveyDescription').value = survey.description || '';
                document.getElementById('surveyStatus').value = survey.status;

                // Convert backend format to frontend format
                questions = (data.questions || []).map(q => {
                    const question = {
                        type: q.type,
                        question: q.question,
                        required: q.required,
                        order: q.order,
                        tableConfig: q.tableConfig
                    };
                    
                    // Convert 'answers' to 'options' for radio/checkbox
                    if (q.answers && q.answers.length > 0) {
                        question.options = q.answers.map(a => ({
                            label: a.label,
                            value: a.value
                        }));
                    }
                    
                    return question;
                });
                
                renderQuestions();
            } catch (error) {
                ui.showAlert('L·ªói khi t·∫£i kh·∫£o s√°t: ' + error.message, 'error');
            }
        }

        function showAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.add('active');
            editingQuestionIndex = -1;
            resetQuestionForm();
        }

        function closeAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.remove('active');
        }

        function resetQuestionForm() {
            document.getElementById('questionType').value = 'text';
            document.getElementById('questionText').value = '';
            document.getElementById('questionRequired').checked = false;
            document.getElementById('optionsList').innerHTML = '';
            updateQuestionForm();
        }

        function updateQuestionForm() {
            const type = document.getElementById('questionType').value;
            const optionsSection = document.getElementById('optionsSection');
            const tableSection = document.getElementById('tableSection');

            optionsSection.style.display = 'none';
            tableSection.style.display = 'none';

            if (type === 'radio' || type === 'checkbox') {
                optionsSection.style.display = 'block';
                if (document.getElementById('optionsList').children.length === 0) {
                    addOption();
                    addOption();
                }
            } else if (type === 'table-single' || type === 'table-multiple') {
                tableSection.style.display = 'block';
            }
        }

        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
        <input type="text" class="form-control" placeholder="L·ª±a ch·ªçn ${optionsList.children.length + 1}">
        <button onclick="this.parentElement.remove()" class="btn btn-sm btn-danger">√ó</button>
      `;
            optionsList.appendChild(optionDiv);
        }

        function addQuestion() {
            const type = document.getElementById('questionType').value;
            const text = document.getElementById('questionText').value;
            const required = document.getElementById('questionRequired').checked;

            if (!text.trim()) {
                ui.showAlert('Vui l√≤ng nh·∫≠p c√¢u h·ªèi', 'error');
                return;
            }

            const question = {
                type,
                question: text,
                required,
                order: questions.length
            };

            if (type === 'radio' || type === 'checkbox') {
                const optionInputs = document.querySelectorAll('#optionsList input');
                question.options = Array.from(optionInputs)
                    .map((input, index) => ({
                        label: input.value || `L·ª±a ch·ªçn ${index + 1}`,
                        value: input.value || `option_${index + 1}`
                    }))
                    .filter(opt => opt.label.trim() !== '');

                if (question.options.length === 0) {
                    ui.showAlert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt l·ª±a ch·ªçn', 'error');
                    return;
                }
            }

            if (type === 'table-single' || type === 'table-multiple') {
                const rows = document.getElementById('tableRows').value.split('\n').filter(r => r.trim());
                const cols = document.getElementById('tableCols').value.split('\n').filter(c => c.trim());

                if (rows.length === 0 || cols.length === 0) {
                    ui.showAlert('Vui l√≤ng nh·∫≠p h√†ng v√† c·ªôt cho b·∫£ng', 'error');
                    return;
                }

                question.tableConfig = { rows, columns: cols };
            }

            if (editingQuestionIndex >= 0) {
                questions[editingQuestionIndex] = question;
            } else {
                questions.push(question);
            }

            renderQuestions();
            closeAddQuestionModal();
            ui.showAlert('ƒê√£ th√™m c√¢u h·ªèi', 'success');
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');

            if (questions.length === 0) {
                container.innerHTML = `
          <p class="text-secondary text-center" style="padding: 2rem 0;">
            Ch∆∞a c√≥ c√¢u h·ªèi n√†o. Nh·∫•n "Th√™m c√¢u h·ªèi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
          </p>
        `;
                return;
            }

            container.innerHTML = questions.map((q, index) => `
        <div class="question-item fade-in">
          <div class="question-header">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge badge-primary">${getQuestionTypeLabel(q.type)}</span>
                ${q.required ? '<span class="badge badge-warning">B·∫Øt bu·ªôc</span>' : ''}
              </div>
              <h4 style="margin-top: 0.5rem;">${index + 1}. ${q.question}</h4>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="editQuestion(${index})" class="btn btn-sm btn-secondary">‚úèÔ∏è</button>
              <button onclick="deleteQuestion(${index})" class="btn btn-sm btn-danger">üóëÔ∏è</button>
            </div>
          </div>
          <div>${renderQuestionPreview(q)}</div>
        </div>
      `).join('');
        }

        function getQuestionTypeLabel(type) {
            const labels = {
                'text': 'VƒÉn b·∫£n',
                'radio': 'M·ªôt l·ª±a ch·ªçn',
                'checkbox': 'Nhi·ªÅu l·ª±a ch·ªçn',
                'date': 'Ng√†y th√°ng',
                'table-single': 'B·∫£ng - M·ªôt l·ª±a ch·ªçn',
                'table-multiple': 'B·∫£ng - Nhi·ªÅu l·ª±a ch·ªçn'
            };
            return labels[type] || type;
        }

        function renderQuestionPreview(q) {
            if (q.type === 'text') {
                return '<input type="text" class="form-control" placeholder="C√¢u tr·∫£ l·ªùi vƒÉn b·∫£n" disabled>';
            } else if (q.type === 'radio' || q.type === 'checkbox') {
                // Handle both 'options' (frontend) and 'answers' (backend)
                const opts = q.options || q.answers || [];
                if (opts.length === 0) {
                    return '<p class="text-muted">Ch∆∞a c√≥ l·ª±a ch·ªçn</p>';
                }
                return opts.map(opt => `
          <div class="form-check">
            <input type="${q.type}" class="form-check-input" disabled>
            <label class="form-check-label">${opt.label}</label>
          </div>
        `).join('');
            } else if (q.type === 'date') {
                return '<input type="date" class="form-control" disabled>';
            } else if (q.type === 'table-single' || q.type === 'table-multiple') {
                if (!q.tableConfig || !q.tableConfig.rows || !q.tableConfig.columns) {
                    return '<p class="text-muted">Ch∆∞a c·∫•u h√¨nh b·∫£ng</p>';
                }
                return `<p class="text-secondary">B·∫£ng: ${q.tableConfig.rows.length} h√†ng √ó ${q.tableConfig.columns.length} c·ªôt</p>`;
            }
            return '';
        }

        function editQuestion(index) {
            editingQuestionIndex = index;
            const q = questions[index];

            document.getElementById('questionType').value = q.type;
            document.getElementById('questionText').value = q.question;
            document.getElementById('questionRequired').checked = q.required;

            updateQuestionForm();

            if (q.type === 'radio' || q.type === 'checkbox') {
                const optionsList = document.getElementById('optionsList');
                optionsList.innerHTML = '';
                q.options.forEach(opt => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    optionDiv.innerHTML = `
            <input type="text" class="form-control" value="${opt.label}">
            <button onclick="this.parentElement.remove()" class="btn btn-sm btn-danger">√ó</button>
          `;
                    optionsList.appendChild(optionDiv);
                });
            } else if (q.type === 'table-single' || q.type === 'table-multiple') {
                document.getElementById('tableRows').value = q.tableConfig.rows.join('\n');
                document.getElementById('tableCols').value = q.tableConfig.columns.join('\n');
            }

            showAddQuestionModal();
        }

        function deleteQuestion(index) {
            if (ui.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi n√†y?')) {
                questions.splice(index, 1);
                renderQuestions();
                ui.showAlert('ƒê√£ x√≥a c√¢u h·ªèi', 'success');
            }
        }

        async function saveSurvey() {
            const title = document.getElementById('surveyTitle').value;
            const description = document.getElementById('surveyDescription').value;
            const status = document.getElementById('surveyStatus').value;

            if (!title.trim()) {
                ui.showAlert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ kh·∫£o s√°t', 'error');
                return;
            }

            if (questions.length === 0) {
                ui.showAlert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi', 'error');
                return;
            }

            const surveyData = {
                title,
                description,
                status,
                questions
            };

            try {
                if (surveyId) {
                    await adminApi.put(`/surveys/${surveyId}`, surveyData);
                    ui.showAlert('ƒê√£ c·∫≠p nh·∫≠t kh·∫£o s√°t th√†nh c√¥ng', 'success');
                } else {
                    console.log('Creating survey with data:', surveyData); // Debug
                    const data = await adminApi.post('/surveys', surveyData);
                    console.log('Survey created, response:', data); // Debug
                    
                    surveyId = data.survey._id;
                    
                    // Verify questions were created
                    if (data.questions && data.questions.length > 0) {
                        console.log('Questions created:', data.questions.length);
                        console.log('First question _id:', data.questions[0]._id);
                    } else {
                        console.warn('WARNING: No questions returned from backend!');
                    }
                    
                    ui.showAlert('ƒê√£ t·∫°o kh·∫£o s√°t th√†nh c√¥ng', 'success');
                }

                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } catch (error) {
                console.error('Error saving survey:', error); // Debug
                ui.showAlert('L·ªói khi l∆∞u kh·∫£o s√°t: ' + error.message, 'error');
            }
        }

        function previewSurvey() {
            if (surveyId) {
                window.open(`/survey/${surveyId}`, '_blank');
            } else {
                ui.showAlert('Vui l√≤ng l∆∞u kh·∫£o s√°t tr∆∞·ªõc khi xem tr∆∞·ªõc', 'warning');
            }
        }
    </script>
</body>

</html>